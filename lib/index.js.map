{"version":3,"sources":["../src/index.js"],"names":["mongoose","require","test","version","Promise","connect","jest","fn","mockImplementation","resolve","createConnection","mockReturnValue","model","bind","on","once","then","ops","mockedReturn","cb","op","modelName","_mongooseOptions","Model","mock","mockingoose","__mocks","err","Error","includes","Array","isArray","map","item","doc","e","validateSync","lean","rawResult","toObject","forEach","Query","prototype","criteria","options","callback","merge","arguments","length","undefined","exec","call","Aggregate","_model","aggregate","insertMany","arr","Object","assign","instance","methodName","constructor","hooks","reject","execPre","ret","execPost","err2","ret2","err3","doMock","proxyTarget","resetAll","toJSON","getMockController","prop","toReturn","o","hasOwnProperty","reset","proxyTraps","get","target","Reflect","apply","thisArg","mockModel","Proxy","module","exports"],"mappings":"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","sourcesContent":["const mongoose = require('mongoose');\r\n\r\nif (!/^5/.test(mongoose.version)) {\r\n  mongoose.Promise = Promise;\r\n}\r\n\r\nmongoose.connect = jest\r\n  .fn()\r\n  .mockImplementation(() => Promise.resolve());\r\n\r\nmongoose.createConnection = jest.fn().mockReturnValue({\r\n  catch() {\r\n    /* no op */\r\n  },\r\n  model: mongoose.model.bind(mongoose),\r\n  on: jest.fn(),\r\n  once: jest.fn(),\r\n  then(resolve) {\r\n    return Promise.resolve(resolve(this));\r\n  },\r\n});\r\n\r\nconst ops = [\r\n  'find',\r\n  'findOne',\r\n  'count',\r\n  'countDocuments',\r\n  'estimatedDocumentCount',\r\n  'distinct',\r\n  'findOneAndUpdate',\r\n  'findOneAndDelete',\r\n  'findOneAndRemove',\r\n  'findOneAndReplace',\r\n  'remove',\r\n  'update',\r\n  'updateOne',\r\n  'updateMany',\r\n  'deleteOne',\r\n  'deleteMany',\r\n  'save',\r\n  'aggregate',\r\n];\r\n\r\nconst mockedReturn = async function(cb) {\r\n  const {\r\n    op,\r\n    model: { modelName },\r\n    _mongooseOptions = {},\r\n  } = this;\r\n  const Model = mongoose.model(modelName);\r\n\r\n  let mock =\r\n    mockingoose.__mocks[modelName] && mockingoose.__mocks[modelName][op];\r\n\r\n  let err = null;\r\n\r\n  if (mock instanceof Error) {\r\n    err = mock;\r\n  }\r\n\r\n  if (typeof mock === 'function') {\r\n    mock = await mock(this);\r\n  }\r\n\r\n  if (!mock && op === 'save') {\r\n    mock = this;\r\n  }\r\n\r\n  if (\r\n    mock &&\r\n    !(mock instanceof Model) &&\r\n    ![\r\n      'remove',\r\n      'deleteOne',\r\n      'deleteMany',\r\n      'update',\r\n      'updateOne',\r\n      'updateMany',\r\n      'count',\r\n      'countDocuments',\r\n      'estimatedDocumentCount',\r\n      'distinct',\r\n    ].includes(op)\r\n  ) {\r\n    mock = Array.isArray(mock)\r\n      ? mock.map(item => new Model(item))\r\n      : new Model(mock);\r\n\r\n    if(op === 'insertMany') {\r\n      if(!Array.isArray(mock)) mock = [mock];\r\n\r\n      for(const doc of mock) {\r\n        const e = doc.validateSync();\r\n        if(e) throw e;\r\n      }\r\n    }\r\n\r\n    if (_mongooseOptions.lean || _mongooseOptions.rawResult) {\r\n      mock = Array.isArray(mock)\r\n        ? mock.map(item => item.toObject())\r\n        : mock.toObject();\r\n    }\r\n  }\r\n\r\n  if (cb) {\r\n    return cb(err, mock);\r\n  }\r\n\r\n  if (err) {\r\n    throw err;\r\n  }\r\n\r\n  return mock;\r\n};\r\n\r\nops.forEach(op => {\r\n  mongoose.Query.prototype[op] = jest\r\n    .fn()\r\n    .mockImplementation(function(criteria, doc, options, callback) {\r\n      if (\r\n        [\r\n          'find',\r\n          'findOne',\r\n          'count',\r\n          'countDocuments',\r\n          'remove',\r\n          'deleteOne',\r\n          'deleteMany',\r\n          'update',\r\n          'updateOne',\r\n          'updateMany',\r\n          'findOneAndUpdate',\r\n          'findOneAndRemove',\r\n          'findOneAndDelete',\r\n          'findOneAndReplace',\r\n        ].includes(op) &&\r\n        typeof criteria !== 'function'\r\n      ) {\r\n        // find and findOne can take conditions as the first paramter\r\n        // ensure they make it into the Query conditions\r\n        this.merge(criteria);\r\n      }\r\n\r\n      if (['distinct'].includes(op) && typeof doc !== 'function') {\r\n        // distinct has the conditions as the second parameter\r\n        this.merge(doc);\r\n      }\r\n\r\n      switch (arguments.length) {\r\n        case 4:\r\n        case 3:\r\n          if (typeof options === 'function') {\r\n            callback = options;\r\n            options = {};\r\n          }\r\n          break;\r\n        case 2:\r\n          if (typeof doc === 'function') {\r\n            callback = doc;\r\n            doc = criteria;\r\n            criteria = undefined;\r\n          }\r\n          options = undefined;\r\n          break;\r\n        case 1:\r\n          if (typeof criteria === 'function') {\r\n            callback = criteria;\r\n            criteria = options = doc = undefined;\r\n          } else {\r\n            doc = criteria;\r\n            criteria = options = undefined;\r\n          }\r\n      }\r\n\r\n      this.op = op;\r\n\r\n      if (!callback) {\r\n        return this;\r\n      }\r\n\r\n      return this.exec.call(this, callback);\r\n    });\r\n});\r\n\r\nmongoose.Query.prototype.exec = jest.fn().mockImplementation(function(cb) {\r\n  return mockedReturn.call(this, cb);\r\n});\r\n\r\nmongoose.Aggregate.prototype.exec = jest\r\n  .fn()\r\n  .mockImplementation(async function(cb) {\r\n    const {\r\n      _model: { modelName },\r\n    } = this;\r\n\r\n    let mock =\r\n      mockingoose.__mocks[modelName] &&\r\n      mockingoose.__mocks[modelName].aggregate;\r\n\r\n    let err = null;\r\n\r\n    if (mock instanceof Error) {\r\n      err = mock;\r\n    }\r\n\r\n    if (typeof mock === 'function') {\r\n      mock = await mock(this);\r\n    }\r\n\r\n    if (cb) {\r\n      return cb(err, mock);\r\n    }\r\n\r\n    if (err) {\r\n      throw err;\r\n    }\r\n\r\n    return mock;\r\n  });\r\n\r\nmongoose.Model.insertMany = jest\r\n  .fn()\r\n  .mockImplementation(function(arr, options, cb) {\r\n    const op = 'insertMany';\r\n    const { modelName } = this;\r\n\r\n    if (typeof options === 'function') {\r\n      cb = options;\r\n      options = null;\r\n    } else {\r\n      this._mongooseOptions = options;\r\n    }\r\n\r\n    Object.assign(this, { op, model: { modelName }})\r\n    return mockedReturn.call(this, cb);\r\n  })\r\n\r\nconst instance = ['remove', 'save'];\r\n\r\ninstance.forEach(methodName => {\r\n  mongoose.Model.prototype[methodName] = jest\r\n    .fn()\r\n    .mockImplementation(function(options, cb) {\r\n      const op = methodName;\r\n      const { modelName } = this.constructor;\r\n\r\n      if (typeof options === 'function') {\r\n        cb = options;\r\n      }\r\n\r\n      Object.assign(this, { op, model: { modelName } });\r\n\r\n      const hooks = this.constructor.hooks;\r\n\r\n      return new Promise((resolve, reject) => {\r\n        hooks.execPre(op, this, [cb], err => {\r\n          if (err) {\r\n            reject(err);\r\n            return;\r\n          }\r\n\r\n          const ret = mockedReturn.call(this, cb);\r\n\r\n          if (cb) {\r\n            hooks.execPost(op, this, [ret], err2 => {\r\n              if (err2) {\r\n                reject(err2);\r\n                return;\r\n              }\r\n\r\n              resolve(ret);\r\n            });\r\n          } else {\r\n            ret\r\n              .then(ret2 => {\r\n                hooks.execPost(op, this, [ret2], err3 => {\r\n                  if (err3) {\r\n                    reject(err3);\r\n                    return;\r\n                  }\r\n\r\n                  resolve(ret2);\r\n                });\r\n              })\r\n              .catch(reject);\r\n          }\r\n        });\r\n      });\r\n    });\r\n});\r\n\r\njest.doMock('mongoose', () => mongoose);\r\n\r\n// extend a plain function, we will override it with the Proxy later\r\nconst proxyTarget = Object.assign(() => void 0, {\r\n  __mocks: {},\r\n  resetAll() {\r\n    this.__mocks = {};\r\n  },\r\n  toJSON() {\r\n    return this.__mocks;\r\n  },\r\n});\r\n\r\nconst getMockController = prop => {\r\n  return {\r\n    toReturn(o, op = 'find') {\r\n      proxyTarget.__mocks.hasOwnProperty(prop)\r\n        ? (proxyTarget.__mocks[prop][op] = o)\r\n        : (proxyTarget.__mocks[prop] = { [op]: o });\r\n\r\n      return this;\r\n    },\r\n\r\n    reset(op) {\r\n      if (op) {\r\n        delete proxyTarget.__mocks[prop][op];\r\n      } else {\r\n        delete proxyTarget.__mocks[prop];\r\n      }\r\n\r\n      return this;\r\n    },\r\n\r\n    toJSON() {\r\n      return proxyTarget.__mocks[prop] || {};\r\n    },\r\n  };\r\n};\r\n\r\nconst proxyTraps = {\r\n  get(target, prop) {\r\n    if (target.hasOwnProperty(prop)) {\r\n      return Reflect.get(target, prop);\r\n    }\r\n\r\n    return getMockController(prop);\r\n  },\r\n  apply: (target, thisArg, [prop]) => mockModel(prop),\r\n};\r\n\r\nconst mockingoose = new Proxy(proxyTarget, proxyTraps);\r\n\r\n/**\r\n * Returns a helper with which you can set up mocks for a particular Model\r\n */\r\nconst mockModel = (model) => {\r\n  const modelName = typeof model === 'function' ? model.modelName : model;\r\n  if (typeof modelName === 'string') {\r\n    return getMockController(modelName);\r\n  } else {\r\n    throw new Error('model must be a string or mongoose.Model');\r\n  }\r\n};\r\n\r\nmodule.exports = mockingoose;\r\n"],"file":"index.js"}