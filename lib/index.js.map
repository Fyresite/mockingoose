{"version":3,"sources":["../src/index.js"],"names":["Promise","connect","jest","fn","ops","mockedReturn","cb","op","modelName","model","mock","mockingoose","__mocks","err","Error","reject","resolve","forEach","Query","prototype","mockImplementation","criteria","doc","options","callback","arguments","length","undefined","exec","call","Model","save","constructor","Object","assign","doMock","target","resetAll","traps","get","prop","hasOwnProperty","Reflect","toReturn","o","reset","Proxy"],"mappings":"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","file":"index.js","sourcesContent":["import mongoose from 'mongoose';\r\n\r\nmongoose.Promise = Promise;\r\nmongoose.connect = jest.fn();\r\n\r\nconst ops = [\r\n  'find',\r\n  'findOne',\r\n  'count',\r\n  'distinct',\r\n  'findOneAndUpdate',\r\n  'findOneAndRemove',\r\n  'remove',\r\n  'deleteOne',\r\n  'deleteMany'\r\n];\r\n\r\nconst mockedReturn = function(cb) {\r\n  const { op, model: { modelName }} = this;\r\n\r\n  let mock = mockingoose.__mocks[modelName] && mockingoose.__mocks[modelName][op];\r\n\r\n  if(!mock && op === 'save') { mock = this;}\r\n\r\n  let err = null;\r\n\r\n  if(mock instanceof Error) err = mock;\r\n\r\n  if(cb) return cb(err, mock);\r\n\r\n  if(err) return Promise.reject(err);\r\n\r\n  return Promise.resolve(mock)\r\n};\r\n\r\nops.forEach(op => {\r\n  mongoose.Query.prototype[op] = jest.fn().mockImplementation(function (criteria, doc, options, callback) {\r\n    switch (arguments.length) {\r\n      case 3:\r\n        if (typeof options === 'function') {\r\n          callback = options;\r\n          options = {};\r\n        }\r\n        break;\r\n      case 2:\r\n        if (typeof doc === 'function') {\r\n          callback = doc;\r\n          doc = criteria;\r\n          criteria = undefined;\r\n        }\r\n        options = undefined;\r\n        break;\r\n      case 1:\r\n        if (typeof criteria === 'function') {\r\n          callback = criteria;\r\n          criteria = options = doc = undefined;\r\n        } else {\r\n          doc = criteria;\r\n          criteria = options = undefined;\r\n        }\r\n    }\r\n\r\n    this.op = op;\r\n\r\n    if(!callback) return this;\r\n\r\n    return this.exec.call(this, callback);\r\n  })\r\n});\r\n\r\nmongoose.Query.prototype.exec = jest.fn().mockImplementation(function cb(cb) {\r\n  return mockedReturn.call(this, cb);\r\n});\r\n\r\nmongoose.Model.prototype.save = function(options, cb) {\r\n  const op = 'save';\r\n  const { modelName } = this.constructor;\r\n\r\n  if(typeof options === 'function') cb = options;\r\n\r\n  Object.assign(this, { op, model: { modelName }});\r\n\r\n  return mockedReturn.call(this, cb);\r\n};\r\n\r\njest.doMock('mongoose', () => mongoose);\r\n\r\nconst target = {\r\n  __mocks: {},\r\n  resetAll() { this.__mocks = {} }\r\n};\r\n\r\nconst traps = {\r\n  get(target, prop) {\r\n    if(target.hasOwnProperty(prop)) return Reflect.get(target, prop);\r\n\r\n    return {\r\n      toReturn(o, op = 'find') {\r\n        target.__mocks[prop] = {\r\n          [op]: o\r\n        };\r\n      },\r\n\r\n      reset(op) {\r\n        if(op) return delete target.__mocks[prop][op];\r\n        delete target.__mocks[prop]\r\n      }\r\n    }\r\n  }\r\n};\r\n\r\nconst mockingoose = new Proxy(target, traps);\r\n\r\nexport default mockingoose;\r\n"]}